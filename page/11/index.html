<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"right","display":"hide","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="纪光的博客">
<meta property="og:url" content="http://yoursite.com/page/11/index.html">
<meta property="og:site_name" content="纪光的博客">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="纪光的博客">
  <link rel="canonical" href="http://yoursite.com/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>纪光的博客</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?bca403b673d79e83a47dc62fea1dd605";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">纪光的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
        
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      
    
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/02/flink/SLS日志带来的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/09/02/flink/SLS日志带来的问题/" class="post-title-link" itemprop="url">SLS日志带来的问题</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-09-02 10:16:59" itemprop="dateCreated datePublished" datetime="2020-09-02T10:16:59+08:00">2020-09-02</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flink/" itemprop="url" rel="index">
                    <span itemprop="name">flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/09/02/flink/SLS日志带来的问题/" class="post-meta-item leancloud_visitors" data-flag-title="SLS日志带来的问题" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>​    我司的实时计算平台的Flink任务是把日志打到阿里云的日志服务（SLS）上面的，相关基础知识请见参考文档。 </p>
<p>​    在实时计算平台的Flink版本由1.9升级到1.10的过程中，发现某些写HDFS的任务经常重启，查看日志发现是255的问题，详细error日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">level: ERROR</span><br><span class="line">log: 2020-09-02 11:03:35,533 kafka2hive_ireport_jianduoduo_pb2_unfold_testf10 ERROR org.apache.flink.yarn.YarnResourceManager - Closing TaskExecutor connection container_1597847003686_0248_01_000005. Because: Exception from container-launch. Container id: container_1597847003686_0248_01_000005 Exit code: 255 Stack trace: ExitCodeException exitCode=255: at org.apache.hadoop.util.Shell.runCommand(Shell.java:604) at org.apache.hadoop.util.Shell.run(Shell.java:507) at org.apache.hadoop.util.Shell$ShellCommandExecutor.execute(Shell.java:789) at org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor.launchContainer(DefaultContainerExecutor.java:213) at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call(ContainerLaunch.java:302) at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call(ContainerLaunch.java:82) at java.util.concurrent.FutureTask.run(FutureTask.java:266) at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) at java.lang.Thread.run(Thread.java:748) Container exited with a non-zero exit code 255</span><br><span class="line">location: org.apache.flink.runtime.resourcemanager.ResourceManager.closeTaskManagerConnection(ResourceManager.java:792)</span><br><span class="line">message: Closing TaskExecutor connection container_1597847003686_0248_01_000005. Because: Exception from container-launch.</span><br><span class="line">Container id: container_1597847003686_0248_01_000005</span><br><span class="line">Exit code: 255</span><br><span class="line">Stack trace: ExitCodeException exitCode=255:</span><br><span class="line">at org.apache.hadoop.util.Shell.runCommand(Shell.java:604)</span><br><span class="line">at org.apache.hadoop.util.Shell.run(Shell.java:507)</span><br><span class="line">at org.apache.hadoop.util.Shell$ShellCommandExecutor.execute(Shell.java:789)</span><br><span class="line">at org.apache.hadoop.yarn.server.nodemanager.DefaultContainerExecutor.launchContainer(DefaultContainerExecutor.java:213)</span><br><span class="line">at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call(ContainerLaunch.java:302)</span><br><span class="line">at org.apache.hadoop.yarn.server.nodemanager.containermanager.launcher.ContainerLaunch.call(ContainerLaunch.java:82)</span><br><span class="line">at java.util.concurrent.FutureTask.run(FutureTask.java:266)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">at java.lang.Thread.run(Thread.java:748)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Container exited with a non-zero exit code 255</span><br></pre></td></tr></table></figure>

<p>从上述日志可见，是hadoop抛出的错误，但是对排查任务重启用途不大。</p>
<p>除此之外就是container拒绝连接，原因是 container 被kill 掉。</p>
<p>排查了几天，没有头绪，后来怀疑是否是有日志，但是没有打印出来，所以就在log4j.properties配置文件中，新增了个appender，把日志打印的文件，终于发现了问题，日志如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">2020-09-02 16:07:11,788 ERROR org.apache.flink.runtime.taskmanager.Task                     - Encountered fatal error java.lang.OutOfMemoryError - terminating the JVM</span><br><span class="line">java.lang.OutOfMemoryError: Direct buffer memory. The direct out-of-memory error has occurred. This can mean two things: either job(s) require(s) a larger size of JVM direct memory or there is a direct memory leak. The direct memory can be allocated by user code or some of its dependencies. In this case &apos;taskmanager.memory.task.off-heap.size&apos; configuration option should be increased. Flink framework and its dependencies also consume the direct memory, mostly for network communication. The most of network memory is managed by Flink and should not result in out-of-memory error. In certain special cases, in particular for jobs with high parallelism, the framework may require more direct memory which is not managed by Flink. In this case &apos;taskmanager.memory.framework.off-heap.size&apos; configuration option should be increased. If the error persists then there is probably a direct memory leak which has to be investigated and fixed. The task executor has to be shutdown...</span><br><span class="line">        at java.nio.Bits.reserveMemory(Bits.java:694)</span><br><span class="line">        at java.nio.DirectByteBuffer.&lt;init&gt;(DirectByteBuffer.java:123)</span><br><span class="line">        at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311)</span><br><span class="line">        at org.apache.parquet.hadoop.codec.SnappyCompressor.setInput(SnappyCompressor.java:97)</span><br><span class="line">        at org.apache.parquet.hadoop.codec.NonBlockedCompressorStream.write(NonBlockedCompressorStream.java:48)</span><br><span class="line">        at org.apache.parquet.bytes.CapacityByteArrayOutputStream.writeToOutput(CapacityByteArrayOutputStream.java:227)</span><br><span class="line">        at org.apache.parquet.bytes.CapacityByteArrayOutputStream.writeTo(CapacityByteArrayOutputStream.java:249)</span><br><span class="line">        at org.apache.parquet.bytes.BytesInput$CapacityBAOSBytesInput.writeAllTo(BytesInput.java:405)</span><br><span class="line">        at org.apache.parquet.bytes.BytesInput$SequenceBytesIn.writeAllTo(BytesInput.java:296)</span><br><span class="line">        at org.apache.parquet.hadoop.CodecFactory$HeapBytesCompressor.compress(CodecFactory.java:164)</span><br><span class="line">        at org.apache.parquet.hadoop.ColumnChunkPageWriteStore$ColumnChunkPageWriter.writePage(ColumnChunkPageWriteStore.java:95)</span><br><span class="line">        at org.apache.parquet.column.impl.ColumnWriterV1.writePage(ColumnWriterV1.java:147)</span><br><span class="line">        at org.apache.parquet.column.impl.ColumnWriterV1.accountForValueWritten(ColumnWriterV1.java:106)</span><br><span class="line">        at org.apache.parquet.column.impl.ColumnWriterV1.write(ColumnWriterV1.java:200)</span><br><span class="line">        at org.apache.parquet.io.MessageColumnIO$MessageColumnIORecordConsumer.addBinary(MessageColumnIO.java:469)</span><br><span class="line">        at org.apache.parquet.avro.AvroWriteSupport.writeValueWithoutConversion(AvroWriteSupport.java:346)</span><br><span class="line">        at org.apache.parquet.avro.AvroWriteSupport.writeValue(AvroWriteSupport.java:278)</span><br><span class="line">        at org.apache.parquet.avro.AvroWriteSupport.writeRecordFields(AvroWriteSupport.java:191)</span><br><span class="line">        at org.apache.parquet.avro.AvroWriteSupport.write(AvroWriteSupport.java:165)</span><br><span class="line">        at org.apache.parquet.hadoop.InternalParquetRecordWriter.write(InternalParquetRecordWriter.java:128)</span><br><span class="line">        at org.apache.parquet.hadoop.ParquetWriter.write(ParquetWriter.java:299)</span><br><span class="line">        at org.apache.flink.formats.parquet.ParquetBulkWriter.addElement(ParquetBulkWriter.java:52)</span><br><span class="line">        at org.apache.flink.streaming.api.functions.sink.filesystem.BulkPartWriter.write(BulkPartWriter.java:50)</span><br><span class="line">        at org.apache.flink.streaming.api.functions.sink.filesystem.Bucket.write(Bucket.java:214)</span><br><span class="line">        at org.apache.flink.streaming.api.functions.sink.filesystem.Buckets.onElement(Buckets.java:274)</span><br><span class="line">        at org.apache.flink.streaming.api.functions.sink.filesystem.StreamingFileSink.invoke(StreamingFileSink.java:470)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.StreamSink.processElement(StreamSink.java:56)</span><br><span class="line">        at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.pushToOperator(OperatorChain.java:641)</span><br><span class="line">        at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:616)</span><br><span class="line">        at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:596)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:730)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:708)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.StreamMap.processElement(StreamMap.java:41)</span><br><span class="line">        at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.pushToOperator(OperatorChain.java:641)</span><br><span class="line">        at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:616)</span><br><span class="line">        at org.apache.flink.streaming.runtime.tasks.OperatorChain$CopyingChainingOutput.collect(OperatorChain.java:596)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:730)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.AbstractStreamOperator$CountingOutput.collect(AbstractStreamOperator.java:708)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.StreamSourceContexts$NonTimestampContext.collect(StreamSourceContexts.java:104)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.StreamSourceContexts$NonTimestampContext.collectWithTimestamp(StreamSourceContexts.java:111)</span><br><span class="line">        at org.apache.flink.streaming.connectors.kafka.internals.AbstractFetcher.emitRecordWithTimestamp(AbstractFetcher.java:398)</span><br><span class="line">        at org.apache.flink.streaming.connectors.kafka.internal.KafkaFetcher.emitRecord(KafkaFetcher.java:185)</span><br><span class="line">        at org.apache.flink.streaming.connectors.kafka.internal.KafkaFetcher.runFetchLoop(KafkaFetcher.java:150)</span><br><span class="line">        at org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumerBase.runWithPartitionDiscovery(FlinkKafkaConsumerBase.java:728)</span><br><span class="line">        at org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumerBase.run(FlinkKafkaConsumerBase.java:720)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:100)</span><br><span class="line">        at org.apache.flink.streaming.api.operators.StreamSource.run(StreamSource.java:63)</span><br><span class="line">        at org.apache.flink.streaming.runtime.tasks.SourceStreamTask$LegacySourceFunctionThread.run(SourceStreamTask.java:200)</span><br></pre></td></tr></table></figure>

<p>很明显，发生了OOM</p>
<h1 id="内存总结"><a href="#内存总结" class="headerlink" title="内存总结"></a>内存总结</h1><p>1、flink1.10和flink1.9的TM都是15360MB，每个TM的slot数是：8</p>
<p>2、根据jmap -heap pid 查看实际的堆的概要</p>
<p>结论：使用CMS垃圾收集时，需要显示设置NewRatio</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">              #Flink1.10     #Flink1.9      #Flink1.10(去掉CMS) #Flink1.10(CMS设置NewRatio)  </span><br><span class="line">MaxHeapSize   7296.0MB       10496.0MB          7296.0MB        7296.0MB</span><br><span class="line">NewSize       332.75MB       3498.5MB           2432.0MB        2432.0MB</span><br><span class="line">MaxNewSize    332.75MB       3498.5MB           2432.0MB        2432.0MB</span><br><span class="line">OldSize       6963.25MB      6997.5MB           4864.0MB        4864.0MB</span><br><span class="line">NewRatio      2              2                  2               2</span><br><span class="line">SurvivorRatio 8              8                  8               8</span><br><span class="line">MetaspaceSize 20.796875MB    20.796875MB        20.796875MB     20.796875MB</span><br><span class="line">CompressedClassSpaceSize 248.0MB 1024.0MB       248.0MB         248.0MB</span><br><span class="line">MaxMetaspaceSize 256.0MB     17592186044415 MB  256.0MB         256.0MB</span><br></pre></td></tr></table></figure>

<h1 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h1><p>​    经过几天的努力，问题是找到了，但是如何解决呢？</p>
<p>既然是SLS的日志没有打印出来，那么首先从日志入手，通过分析源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ProducerBatch类中，日志发送的条件：</span></span><br><span class="line"><span class="comment">//log4j.appender.loghub.batchCountThreshold </span></span><br><span class="line"><span class="comment">//log4j.appender.loghub.batchSizeThresholdInBytes</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isMeetSendCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> curBatchSizeInBytes &gt;= batchSizeThresholdInBytes || curBatchCount &gt;= batchCountThreshold;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>​    可见是要 缓存到达到 条数或者大小的阈值，那么就会发送。但是无论如何配置这两个参数，都不会在sls中打印日志，这个先放一放。</p>
<p>​    既然是Direct buffer memory发生了OOM，那么入手点就从JVM的Direct内存着手吧。</p>
<p>启动命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> 172.16.190.63</span><br><span class="line"> export HADOOP_USER_NAME=qttods</span><br><span class="line"> export HADOOP_CONF_DIR=/etc/apps/hadoop-conf</span><br><span class="line"> export FLINK_HOME=/data/flink/prd/flink-1.10.1-255</span><br><span class="line"> export FLINK_CONF_DIR=/data/flink/prd/flink-1.10.1-255/conf</span><br><span class="line"> </span><br><span class="line"> /data/flink/prd/flink-1.10.1-255/bin/flink run -d -m yarn-cluster -p 40 -yjm 2048 -ytm 15360 -ys 8 -yqu root.data.stream -ynm kafka2hive_ireport_jianduoduo_pb2_unfold_testf10_jiangjiguang -yD metrics.reporter.prom.labels="libra_job_name=kafka2hive_ireport_jianduoduo_pb2_unfold_testf10;libra_job_owner=yanggang@qutoutiao.net,chuyuqiao@qutoutiao.net,liuguiru@qutoutiao.net" -yD env.java.opts="-server -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=75 -XX:ParallelGCThreads=4 -XX:+AlwaysPreTouch -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/test-255-01.hprof -Xloggc:/tmp/trace-test-255-01.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintHeapAtGC -DjobName=kafka2hive_ireport_jianduoduo_pb2_unfold_testf10" -s hdfs://rt2/user/flink/checkpoints/10a74a92f59f091b23bfedc5c5c6211c/chk-707 -c com.innotechx.Pb2UnfoldToHdfsV2 /tmp/aec4472990a347b5a2d279bc90e1551f-15990382903473729850800121691408.jar --jobConfigPath /tmp/aec4472990a347b5a2d279bc90e1551f-1599038298224329812466599395962.properties --job.name kafka2hive_ireport_jianduoduo_pb2_unfold_testf10</span><br><span class="line"> </span><br><span class="line">  /data/flink/prd/flink-1.10.1-255/bin/flink run -d -m yarn-cluster -p 40 -yjm 2048 -ytm 15360 -ys 8 -yqu root.data.stream -ynm kafka2hive_ireport_jianduoduo_pb2_unfold_testf10_jiangjiguang -yD metrics.reporter.prom.labels="libra_job_name=kafka2hive_ireport_jianduoduo_pb2_unfold_testf10;libra_job_owner=yanggang@qutoutiao.net,chuyuqiao@qutoutiao.net,liuguiru@qutoutiao.net" -yD env.java.opts="-server -DjobName=kafka2hive_ireport_jianduoduo_pb2_unfold_testf10" -s hdfs://rt2/user/flink/checkpoints/10a74a92f59f091b23bfedc5c5c6211c/chk-707 -c com.innotechx.Pb2UnfoldToHdfsV2 /tmp/aec4472990a347b5a2d279bc90e1551f-15990382903473729850800121691408.jar --jobConfigPath /tmp/aec4472990a347b5a2d279bc90e1551f-1599038298224329812466599395962.properties --job.name kafka2hive_ireport_jianduoduo_pb2_unfold_testf10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/data/flink/prd/flink-1.10.1-255/bin/flink run -d -m yarn-cluster -p 40 -yjm 2048 -ytm 15360 -ys 8 -yqu root.data.stream -ynm kafka2hive_ireport_jianduoduo_pb2_unfold_testf10_jiangjiguang -yD taskmanager.memory.network.fraction="0.01" -yD taskmanager.memory.managed.fraction="0.1" -yD metrics.reporter.prom.labels="libra_job_name=kafka2hive_ireport_jianduoduo_pb2_unfold_testf10;libra_job_owner=yanggang@qutoutiao.net,chuyuqiao@qutoutiao.net,liuguiru@qutoutiao.net" -yD env.java.opts="-server -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=75 -XX:ParallelGCThreads=4 -XX:+AlwaysPreTouch -XX:NewRatio=1 -XX:MaxDirectMemorySize=4g  -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp -Xloggc:/tmp/trace-test-255-05.log -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintHeapAtGC -DjobName=kafka2hive_ireport_jianduoduo_pb2_unfold_testf10" -c com.innotechx.Pb2UnfoldToHdfsV2 /tmp/ec5ae33a1f0442e4bd05ed0db720fdd9-15993772169427635195942810927092.jar --jobConfigPath /tmp/ec5ae33a1f0442e4bd05ed0db720fdd9-15993772187798971639293380321851.properties --job.name kafka2hive_ireport_jianduoduo_pb2_unfold_testf10</span><br></pre></td></tr></table></figure>

<p>查看堆的概要信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>flink1.10</span><br><span class="line"><span class="meta">#</span> jmap -heap 41010</span><br><span class="line">Attaching to process ID 41010, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.212-b10</span><br><span class="line"></span><br><span class="line">using parallel threads in the new generation.</span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Concurrent Mark-Sweep GC</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 40</span><br><span class="line">   MaxHeapFreeRatio         = 70</span><br><span class="line">   MaxHeapSize              = 7650410496 (7296.0MB)</span><br><span class="line">   NewSize                  = 348913664 (332.75MB)</span><br><span class="line">   MaxNewSize               = 348913664 (332.75MB)</span><br><span class="line">   OldSize                  = 7301496832 (6963.25MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 260046848 (248.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 268435456 (256.0MB)</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">New Generation (Eden + 1 Survivor Space):</span><br><span class="line">   capacity = 314048512 (299.5MB)</span><br><span class="line">   used     = 276619304 (263.80472564697266MB)</span><br><span class="line">   free     = 37429208 (35.695274353027344MB)</span><br><span class="line">   88.08171140132643% used</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 279183360 (266.25MB)</span><br><span class="line">   used     = 269533872 (257.0475311279297MB)</span><br><span class="line">   free     = 9649488 (9.202468872070312MB)</span><br><span class="line">   96.54367366307218% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 34865152 (33.25MB)</span><br><span class="line">   used     = 7085432 (6.757194519042969MB)</span><br><span class="line">   free     = 27779720 (26.49280548095703MB)</span><br><span class="line">   20.322389530956297% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 34865152 (33.25MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 34865152 (33.25MB)</span><br><span class="line">   0.0% used</span><br><span class="line">concurrent mark-sweep generation:</span><br><span class="line">   capacity = 7301496832 (6963.25MB)</span><br><span class="line">   used     = 2099979624 (2002.696632385254MB)</span><br><span class="line">   free     = 5201517208 (4960.553367614746MB)</span><br><span class="line">   28.760946862244698% used</span><br><span class="line"></span><br><span class="line">22116 interned Strings occupying 2178040 bytes.</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>flink1.9</span><br><span class="line"><span class="meta">#</span>   jmap -heap 14786</span><br><span class="line">Attaching to process ID 14786, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.212-b10</span><br><span class="line"></span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Parallel GC with 35 thread(s)</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 0</span><br><span class="line">   MaxHeapFreeRatio         = 100</span><br><span class="line">   MaxHeapSize              = 11005853696 (10496.0MB)</span><br><span class="line">   NewSize                  = 3668443136 (3498.5MB)</span><br><span class="line">   MaxNewSize               = 3668443136 (3498.5MB)</span><br><span class="line">   OldSize                  = 7337410560 (6997.5MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">PS Young Generation</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 3603955712 (3437.0MB)</span><br><span class="line">   used     = 1283197528 (1223.7525253295898MB)</span><br><span class="line">   free     = 2320758184 (2213.24747467041MB)</span><br><span class="line">   35.60525240993861% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 33030144 (31.5MB)</span><br><span class="line">   used     = 10240816 (9.766403198242188MB)</span><br><span class="line">   free     = 22789328 (21.733596801757812MB)</span><br><span class="line">   31.004454597594247% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 31457280 (30.0MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 31457280 (30.0MB)</span><br><span class="line">   0.0% used</span><br><span class="line">PS Old Generation</span><br><span class="line">   capacity = 7337410560 (6997.5MB)</span><br><span class="line">   used     = 4636194168 (4421.419303894043MB)</span><br><span class="line">   free     = 2701216392 (2576.080696105957MB)</span><br><span class="line">   63.18569923392702% used</span><br><span class="line"></span><br><span class="line">21238 interned Strings occupying 2216688 bytes.</span><br></pre></td></tr></table></figure>

<p>gc分析：几个不同的地方</p>
<p>1.flink1.10的ygc次数是 flink1.9的10倍</p>
<p>2.flink1.10的fgc次数 是 flink1.9的3倍，并且每次都是两次</p>
<p>3.老年代的内存差不多，但是年轻代差了一半</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>flink1.10</span><br><span class="line"><span class="meta">#</span> jstat -gc 44792  30000 3000</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line">34048.0 34048.0  0.0   17960.2 272640.0   0.0    7130368.0  5053278.6  76692.0 73508.0 9676.0 8905.5   2853   56.498   6      0.161   56.659</span><br><span class="line">34048.0 34048.0 29066.3  0.0   272640.0   0.0    7130368.0  5156786.1  76692.0 73573.4 9676.0 8905.5   2946   57.906   6      0.161   58.067</span><br><span class="line">34048.0 34048.0 5823.6  0.0   272640.0 61497.6  7130368.0  5312845.3  76692.0 73580.0 9676.0 8905.5   3042   59.386   6      0.161   59.546</span><br><span class="line">34048.0 34048.0 2743.9  0.0   272640.0 103719.7 7130368.0  2150314.5  76692.0 73569.3 9676.0 8903.2   3136   60.875   8      0.230   61.105</span><br><span class="line">34048.0 34048.0  0.0   19973.2 272640.0 31938.8  7130368.0  2283274.4  76692.0 73569.3 9676.0 8903.2   3233   62.464   8      0.230   62.694</span><br><span class="line"> 34048.0 34048.0 2413.5  0.0   272640.0 190768.7 7130368.0  2357924.5  76948.0 73585.4 9676.0 8903.2   3330   63.882   8      0.230   64.112</span><br><span class="line">34048.0 34048.0 9923.9  0.0   272640.0 30765.9  7130368.0  2431965.7  76948.0 73586.8 9676.0 8903.2   3426   65.261   8      0.230   65.491</span><br><span class="line">34048.0 34048.0 20364.2  0.0   272640.0 168196.2 7130368.0  2503354.2  76948.0 73591.6 9676.0 8903.2   3522   66.737   8      0.230   66.967</span><br><span class="line">34048.0 34048.0 3730.0  0.0   272640.0 151194.1 7130368.0  2757946.3  76948.0 73601.7 9676.0 8904.7   3622   68.301   8      0.230   68.531</span><br><span class="line">34048.0 34048.0 11419.4  0.0   272640.0 107408.4 7130368.0  2856088.4  76948.0 73629.0 9676.0 8906.8   3712   69.647   8      0.230   69.877</span><br><span class="line">34048.0 34048.0 24781.5  0.0   272640.0 97438.2  7130368.0  3489299.4  76948.0 73674.3 9676.0 8908.4   3790   71.381   8      0.230   71.611</span><br><span class="line"> 34048.0 34048.0  0.0   23643.2 272640.0 168464.9 7130368.0  3965166.5  76948.0 73683.1 9676.0 8908.4   3915   74.000   8      0.230   74.230</span><br><span class="line">34048.0 34048.0  0.0   20655.7 272640.0 156331.2 7130368.0  4294415.6  76948.0 73694.9 9676.0 8908.9   4011   76.086   8      0.230   76.316</span><br><span class="line">34048.0 34048.0 15995.2  0.0   272640.0 61402.7  7130368.0  4462356.8  76948.0 73698.4 9676.0 8908.9   4108   78.165   8      0.230   78.395</span><br><span class="line">34048.0 34048.0  0.0   12337.9 272640.0 155669.1 7130368.0  4659455.5  76948.0 73700.0 9676.0 8908.9   4203   80.216   8      0.230   80.446</span><br><span class="line">34048.0 34048.0 5241.2  0.0   272640.0 131752.0 7130368.0  4952546.0  76948.0 73705.0 9676.0 8908.9   4302   82.322   8      0.230   82.552</span><br><span class="line"> 34048.0 34048.0 17571.9  0.0   272640.0 199313.0 7130368.0  5051570.2  76948.0 73710.2 9676.0 8908.9   4398   84.150   8      0.230   84.380</span><br><span class="line">34048.0 34048.0 6498.2  0.0   272640.0 52199.4  7130368.0  5104519.7  76948.0 73721.0 9676.0 8908.9   4496   85.667   8      0.230   85.897</span><br><span class="line">34048.0 34048.0 9111.9  0.0   272640.0 38502.6  7130368.0  5172029.1  76948.0 73735.4 9676.0 8908.9   4594   87.188   8      0.230   87.418</span><br><span class="line">34048.0 34048.0  0.0   18352.7 272640.0 43228.2  7130368.0  5284339.2  76948.0 73756.2 9676.0 8909.9   4689   88.728   8      0.230   88.958</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>flink1.9</span><br><span class="line"><span class="meta">#</span> jstat -gc 14786 30000 3000</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line">45568.0 47616.0  0.0   12921.6 3484672.0 2503523.4 7165440.0  6326798.3  76464.0 73754.2 9392.0 8768.5 214470 3705.983  913   614.443 4320.426</span><br><span class="line">37888.0 37888.0 20193.8  0.0   3506688.0 3372237.9 7165440.0  6387704.6  76464.0 73754.2 9392.0 8768.5 214477 3706.050  913   614.443 4320.493</span><br><span class="line">31232.0 53760.0 31217.9  0.0   3474944.0 1101194.8 7165440.0  6523655.9  76464.0 73754.2 9392.0 8768.5 214485 3706.147  913   614.443 4320.590</span><br><span class="line">60928.0 62976.0  0.0   5540.4 3454976.0 2470735.1 7165440.0  6662801.3  76464.0 73754.2 9392.0 8768.5 214492 3706.219  913   614.443 4320.663</span><br><span class="line">47104.0 48128.0  0.0   7847.3 3483648.0 1235129.2 7165440.0  6788503.2  76464.0 73754.2 9392.0 8768.5 214500 3706.327  913   614.443 4320.770</span><br><span class="line">38400.0 36352.0 17337.3  0.0   3507712.0 3118907.9 7165440.0  6878117.3  76464.0 73754.2 9392.0 8768.5 214507 3706.393  913   614.443 4320.837</span><br><span class="line"> 30208.0 30208.0 4506.1  0.0   3522048.0 1054246.7 7165440.0  6953671.1  76464.0 73754.2 9392.0 8768.5 214515 3706.469  913   614.443 4320.912</span><br><span class="line">29184.0 30208.0  0.0   14626.4 3522048.0 2415288.5 7165440.0  7021759.4  76464.0 73754.2 9392.0 8768.5 214522 3706.536  913   614.443 4320.980</span><br><span class="line">44032.0 44544.0  0.0   4688.7 3493376.0 1107967.4 7165440.0  2424117.6  76464.0 73754.2 9392.0 8768.5 214530 3706.615  914   615.339 4321.954</span><br><span class="line">62976.0 61952.0 5851.1  0.0   3457536.0 3101201.1 7165440.0  2603456.1  76464.0 73754.2 9392.0 8768.5 214537 3706.674  914   615.339 4322.013</span><br><span class="line">47616.0 48640.0  0.0   22723.4 3484672.0 1595221.5 7165440.0  2682181.4  76464.0 73754.2 9392.0 8768.5 214544 3706.715  914   615.339 4322.054</span><br><span class="line"> 135680.0 143360.0  0.0   44444.4 3287552.0 1823553.8 7165440.0  3058429.9  76464.0 73754.2 9392.0 8768.5 214550 3706.810  914   615.339 4322.148</span><br><span class="line">116224.0 114176.0 38072.0  0.0   3352064.0 1633522.4 7165440.0  3630131.4  76464.0 73754.2 9392.0 8768.5 214561 3706.967  914   615.339 4322.306</span><br><span class="line">137216.0 134656.0 19009.1  0.0   3310592.0 2641954.6 7165440.0  3946309.7  76464.0 73754.2 9392.0 8768.5 214569 3707.077  914   615.339 4322.415</span><br><span class="line">106496.0 101888.0 16497.0  0.0   3374080.0 2348381.2 7165440.0  4078682.0  76464.0 73754.2 9392.0 8768.5 214577 3707.168  914   615.339 4322.507</span><br><span class="line">77312.0 75264.0 13088.7  0.0   3429888.0 1659629.8 7165440.0  4281662.3  76464.0 73754.2 9392.0 8768.5 214585 3707.267  914   615.339 4322.606</span><br><span class="line"> 120320.0 117248.0 10710.2  0.0   3344896.0 853387.3 7165440.0  4595702.3  76464.0 73754.2 9392.0 8768.5 214593 3707.378  914   615.339 4322.717</span><br><span class="line">87040.0 84480.0 5025.8  0.0   3410944.0 371810.7 7165440.0  4689140.2  76464.0 73754.2 9392.0 8768.5 214601 3707.449  914   615.339 4322.788</span><br><span class="line">60416.0 62976.0  0.0   21042.2 3452416.0 2314165.5 7165440.0  4736839.7  76464.0 73754.2 9392.0 8768.5 214608 3707.512  914   615.339 4322.851</span><br></pre></td></tr></table></figure>

<p>GC配置参数对比</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>jinfo 14874</span><br><span class="line">						flink1.10		flink1.9  flink1.10</span><br><span class="line">MaxHeapSize				7.125G			10.25G	  12.1G</span><br><span class="line">MaxNewSize				2.375G  		3.4G      6.05G</span><br><span class="line">OldSize					4.75G			6.8G      6.05G</span><br><span class="line">MaxDirectMemorySize		1.125G			4.75G	  4G</span><br><span class="line">CompressedClassSpaceSize 248M			</span><br><span class="line">MaxMetaspaceSize		256M					  1G</span><br><span class="line">pid</span><br></pre></td></tr></table></figure>

<p>di-h4-dn-13.h.ab1.qttsite.net  29166,29200,29210</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://cn.aliyun.com/product/sls" target="_blank" rel="noopener">日志服务（SLS）</a></p>
<p><a href="https://github.com/aliyun/aliyun-log-log4j-appender/blob/master/README_CN.md" target="_blank" rel="noopener">ALIYUN Log4j Appender</a></p>
<p><a href="https://github.com/aliyun/aliyun-log-java-producer" target="_blank" rel="noopener">aliyun-log-java-producer</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/01/flink/Flink源码贡献/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/09/01/flink/Flink源码贡献/" class="post-title-link" itemprop="url">Flink源码贡献</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-09-01 10:37:39" itemprop="dateCreated datePublished" datetime="2020-09-01T10:37:39+08:00">2020-09-01</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flink/" itemprop="url" rel="index">
                    <span itemprop="name">flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/09/01/flink/Flink源码贡献/" class="post-meta-item leancloud_visitors" data-flag-title="Flink源码贡献" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本文用来记录对社区的所有共享</p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/27/hadoop/Parquet数据格式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/27/hadoop/Parquet数据格式/" class="post-title-link" itemprop="url">Parquet学习</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-27 10:34:43" itemprop="dateCreated datePublished" datetime="2020-08-27T10:34:43+08:00">2020-08-27</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/27/hadoop/Parquet数据格式/" class="post-meta-item leancloud_visitors" data-flag-title="Parquet学习" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li><p>Parquet是一个列式存储系统</p>
</li>
<li><p>列式存储通过将相同基本类型的值存储在一起提供高效的编码和解码</p>
</li>
<li><p>Parquet支持Avro、Thrift、Protocol Buffers 等数据格式</p>
</li>
<li><p>Parquet的数据格式也是根据schema定义的</p>
</li>
<li><p>列裁剪</p>
<blockquote>
<p>Parquet可以只读取需要的列，实现高效的列扫描，减少 IO 操作</p>
</blockquote>
</li>
<li><p>谓词下推</p>
<blockquote>
<p>可以过滤掉不符合条件的数据，只读取需要的数据，进一步减少 IO 操作</p>
</blockquote>
</li>
<li><p>高效的压缩与编码</p>
<blockquote>
<p>因为同一列的数据类型相同，所以可以针对不同列使用更合适的压缩与编码方式，降低磁盘存储空间</p>
</blockquote>
</li>
</ul>
<h1 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h1><p><img src="/images/hadoop/parquet-jiagou.png" alt></p>
<ul>
<li><p>数据存储层</p>
<blockquote>
<p>定义 Parquet 文件格式，其中元数据在 parquet-format 项目中定义，包括 Parquet 原始类型定义、Page类型、编码类型、压缩类型等</p>
</blockquote>
</li>
<li><p>对象转换层</p>
<blockquote>
<p>这一层在 parquet-mr 项目中，包含多个模块，作用是完成其他对象模型与 Parquet 内部数据模型的映射和转换，Parquet 的编码方式使用的是 striping and assembly 算法</p>
</blockquote>
</li>
<li><p>对象模型层</p>
<blockquote>
<p>对象模型可以简单理解为内存中的数据表示</p>
<p>定义如何读取 Parquet 文件的内容，这一层转换包括 Avro、Thrift、Protocal Buffer 等对象模型/序列化格式、Hive serde 等的适配</p>
</blockquote>
</li>
</ul>
<h1 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h1><ul>
<li><p>Parquet的数据模型是由schema定义的</p>
</li>
<li><p>schema的结构</p>
<blockquote>
<p>message 是根</p>
<p>message 包含多个fields，每个fields包含三个属性：repetition、type、name  </p>
</blockquote>
</li>
<li><p>repetition</p>
<blockquote>
<p>repetition表示出现的次数，由三种：</p>
<p>1、required   仅仅能出现一次  </p>
<p>2、optional    出现0次或者一次</p>
<p>3、repeated  出现0次或者多次  可以用来表示 list 或set</p>
</blockquote>
</li>
<li><p>type</p>
<blockquote>
<p>type表示数据类型，可以是group或者primitive类型</p>
<p>group和java中的对象类似，可以用来表示map</p>
</blockquote>
</li>
</ul>
<h2 id="Definition-levels"><a href="#Definition-levels" class="headerlink" title="Definition levels"></a>Definition levels</h2><ul>
<li><p>Definition level指明该列的路径上多少个可选field被定义了</p>
<blockquote>
<p>嵌套数据类型的特点是有些field（optional field 和 repeated field）可以是空的，也就是没有定义</p>
<p>从根节点开始遍历，当某一个field的路径上的节点开始是空的时候我们记录下当前的深度作为这个field的Definition Level</p>
<p>如果一个field的definition Level等于这个field的最大definition Level就说明这个field是有数据的</p>
<p>对于required类型的field必须是有定义的，所以这个Definition Level是不需要的</p>
<p>definition Level是该路径上有定义的repeated field 和 optional field的个数，不包括required field，因为required field是必须有定义的</p>
</blockquote>
</li>
</ul>
<h2 id="Repetition-levels"><a href="#Repetition-levels" class="headerlink" title="Repetition levels"></a>Repetition levels</h2><ul>
<li>Repetition level指明该值在路径中哪个repeated field重复</li>
<li>详情见参考文档</li>
</ul>
<h1 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h1><ul>
<li><p>行组(Row Group)</p>
<blockquote>
<p>按照行将数据物理上划分为多个单元，每一个行组包含一定的行数。</p>
<p>一个行组包含这个行组对应的区间内的所有列的列块</p>
</blockquote>
</li>
<li><p>列块(Column Chunk)</p>
<blockquote>
<p>在一个行组中每一列保存在一个列块中，行组中的所有列连续的存储在这个行组文件中。不同的列块可能使用不同的算法进行压缩。一个列块由多个页组成</p>
</blockquote>
</li>
<li><p>页(Page)</p>
<blockquote>
<p>每一个列块划分为多个页，页是压缩和编码的单元，对数据模型来说页是透明的。</p>
<p>在同一个列块的不同页可能使用不同的编码方式。官方建议一个页为8KB。</p>
</blockquote>
</li>
</ul>
<h1 id="谓词下推"><a href="#谓词下推" class="headerlink" title="谓词下推"></a>谓词下推</h1><ul>
<li><p>通过将一些过滤条件尽可能的在最底层执行可以减少每一层交互的数据量</p>
<blockquote>
<p>在Parquet做了更进一步的优化，优化的方法时对每一个Row Group的每一个Column Chunk在存储的时候都计算对应的统计信息，包括该Column Chunk的最大值、最小值和空值个数。通过这些统计值和该列的过滤条件可以判断该Row Group是否需要扫描</p>
</blockquote>
</li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://www.jianshu.com/p/47b39ae336d5" target="_blank" rel="noopener">列存储格式Parquet浅析</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/26/hadoop/Avro数据格式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/26/hadoop/Avro数据格式/" class="post-title-link" itemprop="url">Avro学习</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-26 19:02:42" itemprop="dateCreated datePublished" datetime="2020-08-26T19:02:42+08:00">2020-08-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/hadoop/" itemprop="url" rel="index">
                    <span itemprop="name">hadoop</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/26/hadoop/Avro数据格式/" class="post-meta-item leancloud_visitors" data-flag-title="Avro学习" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>Avro是个数据序列化系统</li>
<li>一种紧凑、快速的二进制文件格式</li>
<li>远程过程调用RPC</li>
<li>通过Schema定义数据格式，可以通过Schema生成静态java类，也可以通过Schema动态生成GenericRecord，当做实体类</li>
<li>Avro的Schema用JSON表示。Schema定义了简单数据类型和复杂数据类型。</li>
</ul>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><p>包含基本和复杂数据类型</p>
<ul>
<li><p>基本数据类型包含8种</p>
<blockquote>
<p>null/boolean/int/long/float/double/bytes/string</p>
<p>基本类型没有属性，类型名字就是类型的名称</p>
</blockquote>
</li>
<li><p>复杂数据类型包6种</p>
<blockquote>
<p>Record/Enum/Array/Map/Union/Fixed</p>
</blockquote>
</li>
<li><p>Record</p>
<blockquote>
<p>1、类型名字是：record</p>
<p>2、支持的属性包括：</p>
<p>  name：record类型的名字(必填)</p>
<p>  namespace：命名空间(可选)</p>
<p>  doc：这个类型的文档说明(可选)</p>
<p>  aliases：record类型的别名，是个字符串数组(可选)</p>
<p>  fields：record类型中的字段，是个对象数组(必填)。每个字段需要以下属性：</p>
<ol>
<li>name：字段名字(必填)</li>
<li>doc：字段说明文档(可选)</li>
<li>type：一个schema的json对象或者一个类型名字(必填)</li>
<li>default：默认值(可选)</li>
<li>order：排序(可选)，只有3个值ascending(默认)，descending或ignore</li>
<li>aliases：别名，字符串数组(可选)</li>
</ol>
</blockquote>
</li>
<li><p>Enum</p>
<blockquote>
<p>1、类型名字是：enum</p>
<p>2、支持的属性包括：</p>
<p>  name：枚举类型的名字(必填)</p>
<p>  namespace：命名空间(可选)</p>
<p>  aliases：字符串数组，别名(可选)</p>
<p>  doc：说明文档(可选)</p>
<p>  symbols：字符串数组，所有的枚举值(必填)，不允许重复数据。</p>
</blockquote>
</li>
<li><p>Array</p>
<blockquote>
<p>1、类型名字是：array</p>
<p>2、支持的属性包括：</p>
<p>  items：数组元素的schema</p>
</blockquote>
</li>
<li><p>Map</p>
<blockquote>
<p>1、类型名字是：map</p>
<p>2、支持的属性包括：</p>
<p>  values：map值的schema</p>
<p>Map的key必须是字符串</p>
</blockquote>
</li>
<li><p>Union</p>
<blockquote>
<p>1、组合类型表示各种类型的组合，使用数组组合</p>
<p>  比如，[“null”, “string”]表示类型既可以为null也可以为string</p>
</blockquote>
</li>
<li><p>Fixed</p>
<blockquote>
<p>1、类型名字是：fixed</p>
<p>2、支持的属性包括：</p>
<p>  name：名字(必填)</p>
<p>  namespace：命名空间(可选)</p>
<p>  aliases：字符串数组，别名(可选)</p>
<p>  size：一个整数，表示每个值的字节数(必填)</p>
</blockquote>
</li>
</ul>
<h1 id="使用实践"><a href="#使用实践" class="headerlink" title="使用实践"></a>使用实践</h1><ul>
<li><p>通过schema由两种方式可以生成静态java类</p>
<blockquote>
<p>1、使用avro-tools-1.8.2.jar手动编译</p>
<p>2、使用maven插件编译，在package时自动生成java类</p>
</blockquote>
</li>
<li><p>maven插件编译</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.avro&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;avro-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.8.2&lt;/version&gt;</span><br><span class="line">  &lt;executions&gt;</span><br><span class="line">    &lt;execution&gt;</span><br><span class="line">      &lt;phase&gt;generate-sources&lt;/phase&gt;</span><br><span class="line">      &lt;goals&gt;</span><br><span class="line">        &lt;goal&gt;schema&lt;/goal&gt;</span><br><span class="line">      &lt;/goals&gt;</span><br><span class="line">      &lt;configuration&gt;</span><br><span class="line">        &lt;sourceDirectory&gt;$&#123;project.basedir&#125;/src/main/avro/&lt;/sourceDirectory&gt;</span><br><span class="line">        &lt;outputDirectory&gt;$&#123;project.basedir&#125;/src/main/java/&lt;/outputDirectory&gt;</span><br><span class="line">      &lt;/configuration&gt;</span><br><span class="line">    &lt;/execution&gt;</span><br><span class="line">  &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://fangjian0423.github.io/2016/02/21/avro-intro/" target="_blank" rel="noopener">Avro介绍</a></p>
<p><a href="http://bigdataer.net/?p=640" target="_blank" rel="noopener">avro入门指南（Java实现）</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/26/flink/Flink获取所有Source和Sink信息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/26/flink/Flink获取所有Source和Sink信息/" class="post-title-link" itemprop="url">Flink获取所有Source和Sink信息</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-26 11:57:42" itemprop="dateCreated datePublished" datetime="2020-08-26T11:57:42+08:00">2020-08-26</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flink/" itemprop="url" rel="index">
                    <span itemprop="name">flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/26/flink/Flink获取所有Source和Sink信息/" class="post-meta-item leancloud_visitors" data-flag-title="Flink获取所有Source和Sink信息" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li><p>首先要搞明白获取Souce和Sink信息有什么意义？</p>
<blockquote>
<p>1、如果没有source和sink信息，那么一个flink任务就是独立的任务，不能和其它flink任务、甚至spark任务联系起来。</p>
<p>2、有了source和sink信息，那么就可以对该任务就行评估、甚至是打分</p>
</blockquote>
</li>
</ul>
<h1 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h1><p>  更重要的一个问题是，如何获取任务的所有Souce和Sink信息？是在任务提交过程中获取，还是提交之后获取，是从任务的哪个阶段获取，下面将要解答这些问题。</p>
<h1 id="具体信息"><a href="#具体信息" class="headerlink" title="具体信息"></a>具体信息</h1><h2 id="Kafka"><a href="#Kafka" class="headerlink" title="Kafka"></a>Kafka</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#kafka的source</span><br><span class="line">java类：org.apache.flink.streaming.connectors.kafka.FlinkKafkaProducer</span><br><span class="line">需要的字段：</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; fields = Stream.of(<span class="string">"properties"</span>,</span><br><span class="line">		<span class="string">"topicsDescriptor"</span>, <span class="string">"discoveryIntervalMillis"</span>, <span class="string">"startupMode"</span>, <span class="string">"KEY_PARTITION_DISCOVERY_INTERVAL_MILLIS"</span>)</span><br><span class="line">  .collect(Collectors.toCollection(HashSet::<span class="keyword">new</span>));</span><br><span class="line">字段示例：</span><br><span class="line">&#123;</span><br><span class="line">    DEFAULT_POLL_TIMEOUT=<span class="number">100</span>,</span><br><span class="line">    pollTimeout=<span class="number">100</span>,</span><br><span class="line">    KEY_POLL_TIMEOUT=flink.poll-timeout,</span><br><span class="line">    properties=&#123;</span><br><span class="line">        key.deserializer=org.apache.kafka.common.serialization.ByteArrayDeserializer,</span><br><span class="line">        bootstrap.servers=kafka.net: <span class="number">9092</span>,</span><br><span class="line">        group.id=libra_log_consumer_02,</span><br><span class="line">        value.deserializer=org.apache.kafka.common.serialization.ByteArrayDeserializer,</span><br><span class="line">        flink.partition-discovery.interval-millis=<span class="number">60000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#kafka的sink</span><br><span class="line">java类：org.apache.flink.streaming.connectors.kafka.FlinkKafkaConsumer</span><br><span class="line">需要的字段：</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; fields = Stream.of(<span class="string">"semantic"</span>,</span><br><span class="line">		<span class="string">"defaultTopicId"</span>, <span class="string">"producerConfig"</span>)</span><br><span class="line">		.collect(Collectors.toCollection(HashSet::<span class="keyword">new</span>));</span><br><span class="line">字段示例：</span><br><span class="line">&#123;</span><br><span class="line">    semantic=AT_LEAST_ONCE,</span><br><span class="line">    producerConfig=&#123;</span><br><span class="line">        transaction.timeout.ms=<span class="number">3600000</span>,</span><br><span class="line">        bootstrap.servers=kafka.net: <span class="number">9092</span>,</span><br><span class="line">        value.serializer=org.apache.kafka.common.serialization.ByteArraySerializer,</span><br><span class="line">        key.serializer=org.apache.kafka.common.serialization.ByteArraySerializer</span><br><span class="line">    &#125;,</span><br><span class="line">    defaultTopicId=bigdata_libra_metrics</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#es5</span><br><span class="line">java类：org.apache.flink.streaming.connectors.elasticsearch5.ElasticsearchSink</span><br><span class="line">字段：callBridge.httpHosts</span><br><span class="line">##es6/7</span><br><span class="line">java类：</span><br><span class="line">org.apache.flink.streaming.connectors.elasticsearch6.ElasticsearchSink</span><br><span class="line">org.apache.flink.streaming.connectors.elasticsearch7.ElasticsearchSink</span><br><span class="line">字段：callBridge.transportAddresses</span><br></pre></td></tr></table></figure>

<h3 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h3><h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="http://wuchong.me/blog/2016/05/03/flink-internals-overview/" target="_blank" rel="noopener">Flink 原理与实现：架构和拓扑概览</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/23/flink/Flink内存解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/23/flink/Flink内存解析/" class="post-title-link" itemprop="url">Flink内存解析(Flink1.10)</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-23 09:14:55" itemprop="dateCreated datePublished" datetime="2020-08-23T09:14:55+08:00">2020-08-23</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/flink/" itemprop="url" rel="index">
                    <span itemprop="name">flink</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/23/flink/Flink内存解析/" class="post-meta-item leancloud_visitors" data-flag-title="Flink内存解析(Flink1.10)" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h1><h2 id="内存概览"><a href="#内存概览" class="headerlink" title="内存概览"></a>内存概览</h2><p><img src="/images/flink/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png" alt="内存模型"></p>
<p><img src="/images/flink/TaskMemory.png" alt="TaskMemory"></p>
<p><img src="/images/flink/FrameworkTaskOff-HeapMemory.png" alt="Off-Heap"></p>
<h2 id="Total-Process-Memory"><a href="#Total-Process-Memory" class="headerlink" title="Total Process Memory"></a>Total Process Memory</h2><ul>
<li><p>TaskExecutor的总内存，和TM内存一致</p>
</li>
<li><p>由三部分组成</p>
<blockquote>
<p>Flink Total Memory + JVM Metaspace + JVM Overhead</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>内存设置参数</p>
<blockquote>
<p>taskmanager.memory.process.size</p>
<p>不建议显示设置</p>
</blockquote>
</li>
</ul>
<h2 id="Total-Flink-Memory"><a href="#Total-Flink-Memory" class="headerlink" title="Total Flink Memory"></a>Total Flink Memory</h2><ul>
<li><p>TaskExecutors中Flink任务使用的总内存</p>
</li>
<li><p>由以下部分组成</p>
<blockquote>
<p>Framework Heap（Heap）</p>
<p>Framework Off-Heap（Direct + Native）</p>
<p>Task Heap（Heap）</p>
<p>Task Off-Heap（Direct + Native）</p>
<p>Managed（Native）</p>
<p>Network（Direct）</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>设置参数</p>
<blockquote>
<p>taskmanager.memory.flink.size</p>
<p>不建议显示设置</p>
</blockquote>
</li>
</ul>
<h2 id="Task-Heap"><a href="#Task-Heap" class="headerlink" title="Task Heap"></a>Task Heap</h2><ul>
<li><p>TaskExecutors的heap内存大小，task使用</p>
</li>
<li><p>配置参数</p>
<blockquote>
<p>taskmanager.memory.task.heap.size</p>
<p>如果没有显示配置，那么就等于</p>
<p>Total Flink Memory - Framework Heap - Task Off-Heap -  Managed Memory - Network </p>
</blockquote>
</li>
</ul>
<h2 id="Task-Off-Heap"><a href="#Task-Off-Heap" class="headerlink" title="Task Off-Heap"></a>Task Off-Heap</h2><ul>
<li><p>TaskExecutors的off-head内存大小</p>
</li>
<li><p>配置参数</p>
<blockquote>
<p>taskmanager.memory.task.off-heap.size</p>
<p>默认值是零</p>
</blockquote>
</li>
</ul>
<h2 id="Framework-Memory"><a href="#Framework-Memory" class="headerlink" title="Framework Memory"></a>Framework Memory</h2><ul>
<li><p>Heap    Direct &amp; Native</p>
</li>
<li><p>Framework是TaskManager维度的，不计入Slot资源</p>
</li>
<li><p>分为Framework Heap 和 Framework Off-Heap</p>
</li>
<li><p>设置参数</p>
<blockquote>
<p>Framework Heap：taskmanager.memory.framework.heap.size  默认值：128MB  </p>
<p>Framework Off-Heap：taskmanager.memory.framework.off-heap.size  默认值：128MB</p>
<p>如果没有充分理由，不要更改内存选项，在诸如Hadoop等Flink的依赖中，可能需要更多的direct或native内存</p>
</blockquote>
</li>
<li><p>说明</p>
<blockquote>
<p>堆总用量限制：-Xmx=Framework Heap + Task Heap</p>
<p>非堆总用量限制：-XX:MaxDirectMemorySize= Framework Off-Heap + Off-Task Heap + Network</p>
<p>无隔离：没有在Slot和Framework 之间做隔离，后续版本：动态切割Slot资源</p>
<p><a href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-56:+Dynamic+Slot+Allocation" target="_blank" rel="noopener">FLIP-56:+Dynamic+Slot+Allocation</a></p>
</blockquote>
</li>
</ul>
<h2 id="Network-Memory"><a href="#Network-Memory" class="headerlink" title="Network Memory"></a>Network Memory</h2><ul>
<li><p>属于Direct Memory</p>
</li>
<li><p>在配置大小后，集群启动后直接申请，不会释放，实际上是个常量</p>
</li>
<li><p>用于上下游算子的 数据传输缓冲</p>
</li>
<li><p>设置参数</p>
<blockquote>
<p>taskmanager.memory.network.min        默认值：64MB    Explicit  </p>
<p>taskmanager.memory.network.max       默认值：1GB       Explicit  </p>
<p>taskmanager.memory.network.fraction 默认值：0.1（Total Flink Memory ）  Implicit</p>
<p>在满足min和max的条件下，设置为fraction，否则就是min或max的值</p>
</blockquote>
</li>
<li><p>特点</p>
<blockquote>
<p>同一TaskExecutor的个Slot之间没有隔离</p>
<p>由作业拓扑决定量，不足会导致运行失败，多了也用不到</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>计算公式</p>
<blockquote>
<p>Network Memory = (inputBuffers + outputBuffers) * bufferSize(32KB)</p>
<p>inputBuffers = remoteChannels * buffersPerChannel(2) + gates * buffersPerGates(8)</p>
<p>​      remoteChannels = 不在当前TM的上游Subtask(Physical Graph Vertex)数量</p>
<p>​      gates = 上游Task(Logical Graph VerTex)数量</p>
<p>outputBuffers = subpartitions + 1</p>
<p>​    subpartitions = 下游Subtask(Physical Graph Vertex)数量</p>
</blockquote>
</li>
</ul>
<h2 id="Managed-Memory"><a href="#Managed-Memory" class="headerlink" title="Managed Memory"></a>Managed Memory</h2><ul>
<li><p>托管内存是 Native Memory，即 不会受到JVM heap  或者Direct 大小的限制</p>
</li>
<li><p>主要用来排序，哈希表，中间结果的缓存和RocksDB状态后端</p>
</li>
<li><p>设置参数</p>
<blockquote>
<p>taskmanager.memory.managed.size         默认值：None</p>
<p>taskmanager.memory.managed.fraction  默认值：0.4（Total Flink Memory ）</p>
<p>当任务是无状态的或者使用MemoryStateBackend or FsStateBackend状态后端时，设置托管内存为零，以确保为用户代码使用的堆分配更多内存</p>
</blockquote>
</li>
<li><p>特点：</p>
<blockquote>
<p>各个Slot之间严格隔离</p>
<p>多点少点都能跑，与性能挂钩</p>
</blockquote>
</li>
<li><p>RocksDB内存限制</p>
<blockquote>
<p>state.backend.rocksdb.memory.managed：默认为true，</p>
<p>设置RocksDB使用的内存大小为Managed Memory，目的是防止容器内存超用，而被YARN杀掉</p>
</blockquote>
</li>
</ul>
<h2 id="JVM-Metaspace"><a href="#JVM-Metaspace" class="headerlink" title="JVM Metaspace"></a>JVM Metaspace</h2><ul>
<li><p>Metaspace内存类型</p>
</li>
<li><p>Explicit</p>
</li>
<li><p>用来存储JVM类的元数据</p>
</li>
<li><p>设置参数</p>
<blockquote>
<p>taskmanager.memory.jvm-metaspace.size  默认值：256 mb</p>
<p>用量上限受JVM严格控制：-XX:MaxMetaspaceSize</p>
</blockquote>
</li>
</ul>
<h2 id="JVM-Overhead"><a href="#JVM-Overhead" class="headerlink" title="JVM Overhead"></a>JVM Overhead</h2><ul>
<li><p>是native memory，不是direct memory</p>
<blockquote>
<p>当Flink计算max direct memory size parameter时，不会计算在内</p>
</blockquote>
</li>
<li><p>Explicit  Range&amp; Implicit Fraction</p>
</li>
<li><p>用来存储 thread stack space, compile cache</p>
</li>
</ul>
<ul>
<li><p>设置参数</p>
<blockquote>
<p>taskmanager.memory.jvm-overhead.min         默认值：192 mb</p>
<p>taskmanager.memory.jvm-overhead.max        默认值：1 gb</p>
<p>taskmanager.memory.jvm-overhead.fraction  默认值：0.1（Total Process Memory）</p>
</blockquote>
</li>
</ul>
<h2 id="Direct-Memory"><a href="#Direct-Memory" class="headerlink" title="Direct Memory"></a>Direct Memory</h2><ul>
<li>包括：Framework Off-Heap（部分） + Task Off-Heap（部分） + Network </li>
<li>用量上限受JVM严格控制：-XX:MaxDirectMemorySize</li>
<li>达到上线时触发GC</li>
</ul>
<h2 id="Native-Memory"><a href="#Native-Memory" class="headerlink" title="Native Memory"></a>Native Memory</h2><ul>
<li><p>包括</p>
<blockquote>
<p>Framework Off-Heap（部分）</p>
<p>Task Off-Heap（部分）</p>
<p>Managed Memory </p>
<p>JVM Overhead</p>
</blockquote>
</li>
<li><p>用量上限不受JVM严格控制</p>
<blockquote>
<p>但是Managed Memory用量上限受Flink严格控制</p>
</blockquote>
</li>
</ul>
<h2 id="Off-Heap-Memory"><a href="#Off-Heap-Memory" class="headerlink" title="Off-Heap Memory"></a>Off-Heap Memory</h2><ul>
<li><p>包括Framework Off-Heap Memory 和Task Off-Heap Memory</p>
</li>
<li><p>两种Off-Heap内存设置，都包含了Direct和Native内存</p>
<blockquote>
<p>用户无需理解Direct/Native内存的区别并分别配置</p>
<p>无法严格控制Direct内存用量，可能导致超用</p>
<p>绝大多数情况下，只需要少量Native内存，FullGC时释放不需要的Direct内存</p>
<p>如果需要大量的Native内存，可以考虑增大JVM Overhead</p>
</blockquote>
</li>
</ul>
<h1 id="参数配置"><a href="#参数配置" class="headerlink" title="参数配置"></a>参数配置</h1><ul>
<li><p>Explicit</p>
<blockquote>
<p>Size, Min/Max</p>
<p>严格保证（包括默认值）</p>
<p>配置不当可能引发冲突</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>Implicit</p>
<blockquote>
<p>Fraction</p>
<p>非严格保证</p>
<p>存在冲突时优先保证Explicit的配置</p>
</blockquote>
</li>
<li><p>避免配置冲突</p>
<blockquote>
<p>1.以下3项至少配置一项，不建议配置两项及以上：</p>
<p>  Total Process</p>
<p>  Total Flink</p>
<p>  Task Heap &amp; Managed</p>
<p>2.至少一个内存部分或总内存大小是Implicit</p>
</blockquote>
</li>
</ul>
<h1 id="JVM参数源码解析"><a href="#JVM参数源码解析" class="headerlink" title="JVM参数源码解析"></a>JVM参数源码解析</h1><p>flink升级到1.10后，内存管理和配置有很大的更改，下面进行具体的分析</p>
<ul>
<li><p>显示配置task堆内存和托管内存大小</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">显示配置：taskmanager.memory.task.heap.size 和 taskmanager.memory.managed.size</span><br><span class="line">  计算其它部分内存：</span><br><span class="line">  taskmanager.memory.framework.heap.size=128m</span><br><span class="line">  taskmanager.memory.framework.off-heap.size=128m</span><br><span class="line">  taskmanager.memory.task.off-heap.size=0</span><br><span class="line">  非网络内存=taskmanager.memory.framework.heap.size </span><br><span class="line">             + taskmanager.memory.framework.off-heap.size </span><br><span class="line">             + taskmanager.memory.task.heap.size</span><br><span class="line">             + taskmanager.memory.task.off-heap.size</span><br><span class="line">             + taskmanager.memory.managed.size</span><br><span class="line"></span><br><span class="line">  若显示配置: taskmanager.memory.flink.size</span><br><span class="line">    则非网络内存 &lt;= taskmanager.memory.flink.size</span><br><span class="line">     那么网络内存 =taskmanager.memory.flink.size - 非网络内存</span><br><span class="line">     检查网络内存 满足 最大值(1gb) 最小值(64m) 和 taskmanager.memory.flink.size * 0.1</span><br><span class="line">  若没有显示配置，</span><br><span class="line">    那么网路内存 &gt; max = max; &lt; min = min; = 比例</span><br><span class="line">  taskmanager.memory.jvm-metaspace.size=256m</span><br><span class="line">  若显示配置: taskmanager.memory.process.size</span><br><span class="line">   overhead= taskmanager.memory.process.size </span><br><span class="line">			  - taskmanager.memory.flink.size </span><br><span class="line">			  - taskmanager.memory.jvm-metaspace.size</span><br><span class="line">   </span><br><span class="line">  最后结果：</span><br><span class="line">  		this.cpuCores = cpuCores;</span><br><span class="line">		this.frameworkHeapSize = frameworkHeapSize;</span><br><span class="line">		this.frameworkOffHeapMemorySize = frameworkOffHeapSize;</span><br><span class="line">		this.taskHeapSize = taskHeapSize;</span><br><span class="line">		this.taskOffHeapSize = taskOffHeapSize;</span><br><span class="line">		this.networkMemSize = networkMemSize;</span><br><span class="line">		this.managedMemorySize = managedMemorySize;</span><br><span class="line">		this.jvmMetaspaceSize = jvmMetaspaceSize;</span><br><span class="line">		this.jvmOverheadSize = jvmOverheadSize;</span><br><span class="line">若显示配置: taskmanager.memory.flink.size</span><br><span class="line"></span><br><span class="line">若显示配置: taskmanager.memory.process.size</span><br><span class="line">  计算其它内存部分: taskmanager.memory.jvm-metaspace.size=256m</span><br><span class="line">  根据比例抽取: overhead</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://www.bilibili.com/video/BV1At4y1U7vH/" target="_blank" rel="noopener">Flink TaskExecutor 内存管理与配置</a></p>
<p><a href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-49%3A+Unified+Memory+Configuration+for+TaskExecutors" target="_blank" rel="noopener">FLIP-49: Unified Memory Configuration for TaskExecutors</a></p>
<p><a href="https://docs.google.com/spreadsheets/d/1mJaMkMPfDJJ-w6nMXALYmTc4XxiV30P5U7DzgwLkSoE/edit#gid=0" target="_blank" rel="noopener">Memory calculations</a></p>
<p><a href="https://github.com/KarmaGYZ/flink-memory-calculator" target="_blank" rel="noopener">flink-memory-calculator</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/17/java/Java锁知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/17/java/Java锁知识/" class="post-title-link" itemprop="url">Java锁知识</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-17 09:49:39" itemprop="dateCreated datePublished" datetime="2020-08-17T09:49:39+08:00">2020-08-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/17/java/Java锁知识/" class="post-meta-item leancloud_visitors" data-flag-title="Java锁知识" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><ul>
<li><p>线程安全</p>
<blockquote>
<p>具有线程安全问题的状态都是 <strong>共享的、可修改的</strong></p>
</blockquote>
</li>
<li><p>保证线程安全</p>
<blockquote>
<p>封装：通过封装，我们可以将对象内部状态隐藏、保护起来。</p>
<p>不可变：final 和 immutable</p>
</blockquote>
</li>
<li><p>线程安全的基本特性</p>
<blockquote>
<p>原子性：简单说就是相关操作不会中途被其他线程干扰，一般通过同步机制实现。</p>
<p>可见性：是一个线程修改了某个共享变量，其状态能够立即被其他线程知晓，通常被解释为将线程本地状态反映到主内存上，volatile 就是负责保证可见性的。</p>
<p>有序性：是保证线程内串行语义，避免指令重排等。</p>
</blockquote>
</li>
<li><p>java对象包含三个部分：对象头、实例数据、填充字节（必须是8的byte的倍数）</p>
<blockquote>
<p>1、对象头存放运行时信息：mark word、class point</p>
<p>class point：指向了当前对象类型所在方法区中的类型数据</p>
<p>mark word：存储当前对象运行状态的数据，</p>
</blockquote>
</li>
<li></li>
</ul>
<h1 id="锁知识"><a href="#锁知识" class="headerlink" title="锁知识"></a>锁知识</h1><ul>
<li><p>每个object都有一把锁，存放于对象头中，锁中记录了当前锁被哪个对象锁占用</p>
</li>
<li><p>锁总共有4中状态：无锁、偏向锁、轻量级锁、重量级锁</p>
</li>
<li><p>锁只能升级、不能降级</p>
</li>
<li><p>无锁</p>
<blockquote>
<p>1、没有对资源锁定、所有线程都能访问同一资源，线程私有、多线程（无竞争），无需对对象进行保护</p>
<p>2、存在竞争，非锁方式同步线程 CAS（compare and swap）</p>
<p>3、cas在操作系统中，同一个一条指令来实现，所以能保证原子性，因此可以用来无锁编程</p>
</blockquote>
</li>
<li><p>偏向锁</p>
<blockquote>
<p>1、加锁后只有一个线程能获取锁，最理想的方式就是不通过mutex lock  和 cas</p>
<p>2、通过mark word中的线程ip来判断，要获取锁的线程是否是已经持有锁的线程</p>
<p>3、当有多个线程竞争锁时，偏向锁会升级为轻量级锁</p>
</blockquote>
</li>
<li><p>轻量级锁</p>
<blockquote>
<p>1、当线程想要获取对象的锁时，看到锁标志位为00，就知道是轻量级锁</p>
<p>2、线程会在自己的虚拟机栈中开启  锁记录（Lock Record）的空间，用来存放mark word的副本以及owner的指针</p>
<p>​      owner的指针指向的 锁记录（Lock Record） 对象</p>
<p>指向栈中锁记录的指针</p>
<p>2、其它线程想要获取锁时，会自旋等待</p>
<p>3、一旦自旋等待的线程超过一个，就会升级为重量级锁</p>
</blockquote>
</li>
<li><p>重量级锁</p>
<blockquote>
<p>1、就和synchronized关键字一样，通过monitor来对线程进行控制，将会完全锁定资源</p>
</blockquote>
</li>
<li><p>锁膨胀</p>
</li>
<li><p>锁降级</p>
</li>
<li><p>偏斜锁（Biased Locking）</p>
<blockquote>
<p>​    当没有竞争出现时，默认会使用偏斜锁。JVM 会利用 CAS 操作（compare and swap），在对象头上的 Mark Word 部分设置线程 ID，以表示这个对象偏向于当前线程，所以并不涉及真正的互斥锁。</p>
<p>​    这样做的假设是基于在很多应用场景中，大部分对象生命周期中最多会被一个线程锁定，使用偏斜锁可以降低无竞争开销。</p>
<p>​    如果有另外的线程试图锁定某个已经被偏斜过的对象，JVM 就需要撤销（revoke）偏斜锁，并切换到轻量级锁实现。</p>
<p>​    轻量级锁依赖 CAS 操作 Mark Word 来试图获取锁，如果重试成功，就使用普通的轻量级锁；否则，进一步升级为重量级锁。</p>
<p>   偏斜锁并不适合所有应用场景，撤销操作（revoke）是比较重的行为</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>自旋锁</p>
<blockquote>
<p>​    竞争锁的失败的线程，并不会真实的在操作系统层面挂起等待，而是JVM会让线程做几个空循环。</p>
<p>​    适用场景：自旋锁可以减少线程的阻塞，这对于锁竞争不激烈，且占用锁时间非常短的代码块来说，有较大的性能提升，因为自旋的消耗会小于线程阻塞挂起操作的消耗。</p>
<p>​    为什么会提出自旋锁，因为互斥锁，在线程的睡眠和唤醒都是复杂而昂贵的操作，需要大量的CPU指令。如果互斥仅仅被锁住是一小段时间，用来进行线程休眠和唤醒的操作时间比睡眠时间还长，更有可能比不上不断自旋锁上轮询的时间长。</p>
</blockquote>
</li>
<li><p>轻量级锁</p>
</li>
<li><p>重量级锁</p>
</li>
<li></li>
</ul>
<h1 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h1><ul>
<li><p>提供了<strong>互斥</strong>和<strong>可见性</strong>语义</p>
</li>
<li><p>可以修饰方法或者代码块</p>
</li>
<li><p>使用monitorenter  monitorexit使线程同步</p>
<blockquote>
<p>进入monitor的线程便拥有了锁</p>
<p>monitor是依赖于操作系统的mutex lock来实现的</p>
<p>每当唤醒或者挂起线程都要操作系统内核态，这种操作是重量级的</p>
</blockquote>
</li>
<li><p>对synchronized优化，引进了偏向锁、轻量级锁</p>
</li>
</ul>
<h1 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h1><ul>
<li><p>再入锁</p>
</li>
<li><p>再入锁可以设置公平性（fairness）</p>
<blockquote>
<p>公平性是指在竞争场景中，当公平性为真时，会倾向于将锁赋予等待时间最久的线程。</p>
</blockquote>
</li>
<li><p>典型使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ReentrantLock fairLock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);<span class="comment">// 这里是演示创建公平锁，一般情况不需要。</span></span><br><span class="line">fairLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123; </span><br><span class="line">  fairLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>提供各种便利方法，进行精细的同步操作</p>
<blockquote>
<p>1、带超时的获取锁尝试。</p>
<p>2、可以判断是否有线程，或者某个特定线程，在排队等待获取锁。</p>
<p>3、可以响应中断请求。</p>
</blockquote>
</li>
<li><p>条件变量(java.util.concurrent.Condition）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Condition 则是将 wait、notify、notifyAll 等操作转化为相应的对象，将复杂而晦涩的同步操作转变为直观可控的对象行为。</span></span><br><span class="line"><span class="comment">//同一锁的情况下可以根据不同的情况执行等待或唤醒的动作。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123; </span><br><span class="line">  <span class="keyword">final</span> ReentrantLock lock = <span class="keyword">this</span>.lock; </span><br><span class="line">  lock.lockInterruptibly(); </span><br><span class="line">  <span class="keyword">try</span> &#123; </span><br><span class="line">    <span class="keyword">while</span> (count == <span class="number">0</span>) </span><br><span class="line">      notEmpty.await(); </span><br><span class="line">    <span class="keyword">return</span> dequeue(); </span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123; </span><br><span class="line">    lock.unlock(); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//notEmpty = lock.newCondition();</span></span><br><span class="line"><span class="comment">//notEmpty.signal()</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="读写锁（ReadWriteLock）"><a href="#读写锁（ReadWriteLock）" class="headerlink" title="读写锁（ReadWriteLock）"></a>读写锁（ReadWriteLock）</h1><ul>
<li><p>如果读锁试图锁定时，写锁是被某个线程持有，读锁将无法获得，而只好等待对方操作结束</p>
</li>
<li><p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RWSample</span> </span>&#123; </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Map m = <span class="keyword">new</span> TreeMap&lt;&gt;(); </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock rwl = <span class="keyword">new</span> ReentrantReadWriteLock(); </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock r = rwl.readLock(); </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Lock w = rwl.writeLock(); </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123; </span><br><span class="line">    r.lock(); </span><br><span class="line">    System.out.println(<span class="string">"读锁锁定！"</span>); </span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> m.get(key); </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123; </span><br><span class="line">      r.unlock(); </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">put</span><span class="params">(String key, String entry)</span> </span>&#123; </span><br><span class="line">    w.lock(); </span><br><span class="line">    System.out.println(<span class="string">"写锁锁定！"</span>); </span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> m.put(key, entry); </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123; </span><br><span class="line">      w.unlock(); </span><br><span class="line">    &#125; </span><br><span class="line">  &#125; </span><br><span class="line">  <span class="comment">// … </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/17/java/Java线程知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/17/java/Java线程知识/" class="post-title-link" itemprop="url">Java线程知识</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-17 09:49:31" itemprop="dateCreated datePublished" datetime="2020-08-17T09:49:31+08:00">2020-08-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/17/java/Java线程知识/" class="post-meta-item leancloud_visitors" data-flag-title="Java线程知识" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="基本知识"><a href="#基本知识" class="headerlink" title="基本知识"></a>基本知识</h1><h2 id="线程知识"><a href="#线程知识" class="headerlink" title="线程知识"></a>线程知识</h2><ul>
<li><p>线程是系统调度的最小单元</p>
<blockquote>
<p>​    一个进程可以包含多个线程，作为任务的真正运作者，有自己的栈（Stack）、寄存器（Register）、本地存储（Thread Local）等，但是会和进程内其他线程共享文件描述符、虚拟地址空间等。</p>
</blockquote>
</li>
<li><p>现在的线程模型是一对一映射到操作系统内核线程。</p>
</li>
</ul>
<h2 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h2><p>线程的状态由Thread.State枚举常量标识：</p>
<ul>
<li><p>NEW</p>
<blockquote>
<p>线程还没有开始执行</p>
</blockquote>
</li>
<li><p>RUNNABLE</p>
<blockquote>
<p>线程正在JVM中执行</p>
</blockquote>
</li>
<li><p>BLOCKED</p>
<blockquote>
<p>线程被阻塞并等待一个监听锁</p>
</blockquote>
</li>
<li><p>WAITING</p>
<blockquote>
<p>线程无期限地等待另外一条线程执行特定操作，调用以下方法会进入该状态：</p>
<p>1.Object.wait()   //其它线程调用Object.notify()或Object.notifyAll() 唤醒该线程</p>
<p>2.Thread.join()   //其它线程终止唤醒该线程</p>
<p>3.LockSupport.park</p>
</blockquote>
</li>
<li><p>TIMED_WAITING</p>
<blockquote>
<p>线程在特定的时间内等待另外一条线程执行特定操作：</p>
<p>1.Thread.sleep</p>
<p>2.Object.wait(long)</p>
<p>3.Thread.join(long)</p>
<p>4.LockSupport.parkNanos</p>
<p>5.LockSupport.parkUntil</p>
</blockquote>
</li>
<li><p>TERMINATED</p>
<blockquote>
<p>线程已经退出</p>
</blockquote>
</li>
</ul>
<h2 id="调用修饰"><a href="#调用修饰" class="headerlink" title="调用修饰"></a>调用修饰</h2><p>表示线程在方法调用时，额外的重要操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">locked &lt;地址&gt; 目标：使用synchronized申请对象锁成功,监视器的拥有者。</span><br><span class="line">waiting to lock &lt;地址&gt; 目标：使用synchronized申请对象锁未成功,在进入区等待。</span><br><span class="line">waiting on &lt;地址&gt; 目标：使用synchronized申请对象锁成功后,释放锁并在等待区等待。</span><br><span class="line">parking to wait for &lt;地址&gt; 目标 //park是基本的线程阻塞原语,不通过监视器在对象上阻塞。</span><br><span class="line">  随concurrent包会出现的新的机制,和synchronized体系不同。</span><br></pre></td></tr></table></figure>

<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href>Java线程与并发编程实践</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/17/java/JVM常用命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/17/java/JVM常用命令/" class="post-title-link" itemprop="url">JVM常用命令</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-17 08:53:28" itemprop="dateCreated datePublished" datetime="2020-08-17T08:53:28+08:00">2020-08-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/17/java/JVM常用命令/" class="post-meta-item leancloud_visitors" data-flag-title="JVM常用命令" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h2><ul>
<li><p>全称为：JVM Statistics Monitoring Tool</p>
</li>
<li><p>用于监控虚拟机各种运行状态信息。包括：类加载、内存、垃圾收集、JIT编译等运行数据。</p>
</li>
<li><p>命令格式</p>
<blockquote>
<p> jstat (-命令选项) (vmid) (间隔时间/毫秒) (查询次数)</p>
</blockquote>
</li>
<li><p>命令选项</p>
<blockquote>
<p>-class  监控类加载、卸载数量、总空间以及类加载所耗费时间</p>
<p>-compiler 输出JIT编译器编译过得方法、耗时等信息</p>
<p>-printcompilation 输出已经被JIT编译的方法</p>
<p>-gc 监视Java堆状况，包括eden、survivor区、老年代、永久区的容量和已使用空间、GC时间合计等信息</p>
<p>-gcutil 与-gc基本相同，侧重于百分比</p>
</blockquote>
</li>
<li><p>类加载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> jstat -class 15780</span><br><span class="line">Loaded  Bytes  Unloaded  Bytes     Time   </span><br><span class="line"> 12969  23843.9      0     0.0     7.43</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译统计</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> jstat -compiler 15780 </span><br><span class="line">Compiled Failed Invalid   Time   FailedType FailedMethod</span><br><span class="line">   12948      5       0    54.25          1 org/springframework/transaction/interceptor/TransactionAttributeSourcePointcut matches</span><br></pre></td></tr></table></figure>
</li>
<li><p>堆内存统计</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> jstat -gccapacity 26114 30000 30</span><br><span class="line"> NGCMN    NGCMX     NGC     S0C   S1C       EC      OGCMN      OGCMX       OGC         OC       MCMN     MCMX      MC     CCSMN    CCSMX     CCSC    YGC    FGC </span><br><span class="line">340736.0 340736.0 340736.0 34048.0 34048.0 272640.0  7130368.0  7130368.0  7130368.0  7130368.0      0.0 1116160.0  76152.0      0.0 1048576.0   9424.0  12572    31</span><br></pre></td></tr></table></figure>
</li>
<li><p>元数据空间统计</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span>jstat -gcmetacapacity 26114 30000 30    </span><br><span class="line">   MCMN       MCMX        MC       CCSMN      CCSMX       CCSC     YGC   FGC    FGCT     GCT   </span><br><span class="line">   0.0  1116160.0    76152.0        0.0  1048576.0     9424.0 13661    34    8.851  436.361</span><br></pre></td></tr></table></figure>
</li>
<li><p>垃圾回收统计</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> jstat -gc 15780</span><br><span class="line"> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    </span><br><span class="line"> CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line"> 0.0   3072.0  0.0   3072.0 1098752.0 730112.0  995328.0   68874.4   75904.0 71841.1 9344.0 8645.2    134    1.588   0      0.000    1.588</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h2><ul>
<li><p>用于生成虚拟机当前时刻的线程快照</p>
<blockquote>
<p>线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合。</p>
<p>主要目的是定位导致线程长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致长时间等待。</p>
</blockquote>
</li>
<li><p>命令格式</p>
<blockquote>
<p>jstack (option) vmid</p>
<p>option选项：</p>
<p>-F 强制输出线程堆栈</p>
<p>-l 除堆栈外，显示关于锁的附加信息</p>
<p>-m 如果调用本地方法，可显示C/C++的堆栈</p>
</blockquote>
</li>
<li><p>命令使用</p>
<blockquote>
<p>jstack -F vmid</p>
</blockquote>
</li>
</ul>
<h2 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h2><ul>
<li><p>用于输出所有内存中的对象的工具</p>
</li>
<li><p>输出堆存储快照</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> live子选项是只输出活的对象到文件</span><br><span class="line">jmap -dump:live,format=b,file=dump.hprof 19570</span><br><span class="line">jmap -dump:format=b,file=dump.hprof 19570</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印正等候回收的对象的信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -finalizerinfo 3772</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印堆的概要信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -heap 47365</span><br></pre></td></tr></table></figure>
</li>
<li><p>显示堆中对象统计信息，类、实例数量、占用空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo:live 19570</span><br><span class="line">jmap -F -histo 19570</span><br></pre></td></tr></table></figure>
</li>
<li><p>打印类加载器信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jmap -clstats 47365</span><br><span class="line"><span class="meta">#</span>会报错，没有解决</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h1><ul>
<li><p>全称Configuration Info for Java，用来实时查看和调整虚拟机的各项参数</p>
</li>
<li><p>用法</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> jinfo -help</span><br><span class="line"><span class="meta">#</span> jinfo [option] pid</span><br><span class="line">  no option 输出全部的参数和系统属性</span><br><span class="line">  -flag name 输出对应名称的参数</span><br><span class="line">  -flag [+|-]name 开启或者关闭对应名称的参数</span><br><span class="line">  -flag name=value 设定对应名称的参数</span><br><span class="line">  -flags 输出全部的参数</span><br><span class="line">  -sysprops 输出系统属性</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
</ul>
<h1 id="实用命令"><a href="#实用命令" class="headerlink" title="实用命令"></a>实用命令</h1><ul>
<li><code>jar -tf xxx.jar |grep xxx.java</code> 查看是否 jar 中存在某个类，如果考虑冲突的话，可以加个参数看下类是由哪里加处理的: <code>-verbose:class</code></li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://www.cnblogs.com/alter888/p/10407952.html" target="_blank" rel="noopener">jstat命令查看jvm的GC情况</a></p>
<p><a href="https://www.cnblogs.com/kongzhongqijing/articles/3630264.html" target="_blank" rel="noopener">java命令—jstack工具</a></p>
<p><a href="https://www.jianshu.com/p/8d8aef212b25" target="_blank" rel="noopener">jvm 性能调优工具之 jinfo</a></p>

        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/17/java/JVM问题排查实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="姜纪光">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="纪光的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            
            <a href="/2020/08/17/java/JVM问题排查实践/" class="post-title-link" itemprop="url">JVM问题排查实践</a>
          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2020-08-17 08:27:23" itemprop="dateCreated datePublished" datetime="2020-08-17T08:27:23+08:00">2020-08-17</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-20 12:19:35" itemprop="dateModified" datetime="2021-06-20T12:19:35+08:00">2021-06-20</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/java/" itemprop="url" rel="index">
                    <span itemprop="name">java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            <span id="/2020/08/17/java/JVM问题排查实践/" class="post-meta-item leancloud_visitors" data-flag-title="JVM问题排查实践" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
          
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="工具实践"><a href="#工具实践" class="headerlink" title="工具实践"></a>工具实践</h1><h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><p><a href="https://jiangjiguang.me/2020/07/10/linux/%E5%B7%A5%E5%85%B7%E5%AE%9E%E8%B7%B5-top/" target="_blank" rel="noopener">工具实战-top</a></p>
<blockquote>
<p>显示进程的所有线程：</p>
<p>top -H -p pid</p>
<p>f add/remove/order/sort 列</p>
<p>R 切换正序/倒序排序</p>
</blockquote>
<h2 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h2><p>用于生成虚拟机当前时刻的线程快照</p>
<blockquote>
<p>jstack -F mvid</p>
</blockquote>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1>
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

    
  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">姜纪光</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">158</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">姜纪光</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">
      
    主题 – <a href="https://mist.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.4.1
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>

<script src="/js/next-boot.js?v=7.4.1"></script>



  





















  

  

  


<script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'MIQC4jJTknc0hjNXDAiIuQ21-9Nh9j0Va',
    appKey: 'vaiXpSQLLMglwYsVLOBLzck4',
    placeholder: "Just go go",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: 'zh-cn' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
